---
description: 0次元速度空間3次元緩和シミュレーションの実装
---

# Role
あなたは計算物理学と運動論的プラズマ理論の専門家です。
特にモンテカルロ法における衝突過程の実装に精通しており、モダンFortran (Fortran 2008) で記述します。

# Goal
空間次元を無視し、速度空間のみを扱う「0次元・3次元速度空間 (0D-3V) モンテカルロシミュレーション」のコードを作成してください。背景プラズマが固定された環境下での、中性粒子の振る舞いを解析できるようにしてください
**目的:** 衝突過程（運動量・エネルギー交換）のみによる速度分布関数の時間発展（緩和過程）を追跡し、空間輸送の影響を排除した状態で物理モデルを検証すること。

# 物理モデルの仕様
1. **次元**: 空間なし (0D), 速度3次元 ($v_x, v_y, v_z$)。位置更新は行わない。
2. **系**:
    - **テスト粒子**: 重水素(D), 質量 $m_{test}$, 初期エネルギー $E_{init}$ (ビーム状分布 または 高温マクスウェル分布)。
    - **背景粒子**: 重水素イオン(D+),電子(e),質量 $m_{i},m_{e}$, 密度 $n_{i},n_{e}$, 温度 $T_{i},T_{e}$ (静止したマクスウェル分布を持つ無限媒質)。
3. **時間発展**: 一定の時間刻み $\Delta t$ で、衝突のみを計算する。
4. **衝突判定アルゴリズム**：
    - ステップごとに全衝突頻度 $\nu_{total} = v \cdot n_{bg} \cdot (\sigma_{CX} + \sigma_{EL} + \sigma_{EI})$ を計算。
    - 衝突確率 $P = 1 - \exp(-\nu_{total} \Delta t)$ と乱数 $R$ を比較して衝突有無を決定。
    - 衝突する場合、断面積の比率に応じてプロセス（CX か Elastic か EI）を選択。
5. **衝突プロセス**:
    以下の2つを実装し、入力フラグでOn/Off可能にする。
    - **(A) 弾性衝突 (Elastic Scattering)**:
        - **重要:** エネルギー緩和を正しく再現するため、**「ターゲット粒子の熱運動」**を考慮すること。
        - アルゴリズム:
            1. 背景温度 $T_{i}$ からターゲット速度 $\mathbf{v}_{i}$ をサンプリング。
            2. 重心系 (Center of Mass frame) に変換。
            3. 散乱角 $\chi$ を決定（※まずは等方散乱 Isotropic Scattering と仮定、散乱角データと切り替え可能に）。
            4. 重心系で速度ベクトルを回転させ、実験室系に戻す。
    - **(B) 荷電交換 (Charge Exchange, CX)**:
        - 衝突後、テスト粒子の速度 $\mathbf{v}_{test}$ を、背景温度 $T_{bg}$ からサンプリングした新しい速度 $\mathbf{v}_{new}$ に完全に入れ替える。
 **対象プロセス**:
    - **荷電交換 (Charge Exchange, CX)**: 粒子が背景粒子とエネルギー・運動量を交換する（速度が背景温度の分布に入れ替わる）。
    - **弾性衝突 (Elastic Scattering)**: エネルギー保存、運動量の方向散乱。衝突断面積と散乱角データは"dd_00_elastic.cdf"から読み込む。
    - **電離衝突**: 粒子が背景電子と衝突し、イオン化する反応。閾値エネルギー以上のエネルギーを受け取った場合にのみ発生する。二次電子は追跡しません。
6. **背景**: 固定された密度一定のプラズマ ($n_{bg}$)、温度 $T_{bg}$、電子密度($n_{e}$)、電子温度（$T_{e}$）。

7. **統計的処理**:
    - 各時刻における「平均エネルギー (Mean Energy)」と「温度 (Temperature)」。
    - 特定時刻におけるエネルギー分布関数 (EDF)。
    - 各時刻における「各反応ごとのエネルギー増減」

# コーディング要件 (Modern Fortran)
- **モジュール構成**:
    - `module particle_data`: 粒子構造体 (速度のみ)。
    - `module collisions`: 弾性衝突（重心系変換含む）とCXのサブルーチン。
    - `module statistics`: エネルギー計算、分布関数のヒストグラム作成。
    - `module main`: 時間ループ。
- **検証用出力**:
    - `relaxation.csv`: 時刻 $t$ vs 平均エネルギー $\langle E \rangle$。
        - ※弾性衝突のみの場合、理論解（背景温度 $T_{bg}$ への指数関数的緩和）と比較するため。
    - `energy_dist.csv`: エネルギービンのヒストグラムデータ。
    - 'ntscrg.csv': 時刻 $t$ vs 1粒子平均の反応ごとのエネルギー変化 $\delta E$ 
- **コンパイル**: Makefileを作成し、コンパイルしやすくすること。

# Workflow Steps

## Step 1: 物理設計 (Design)
- 衝突判定のロジック（分岐比の計算）を数式で示してください。
- 弾性衝突において、静止ターゲット近似ではなく「熱運動するターゲット」との衝突を扱うための数理（重心速度 $\mathbf{V}_{cm}$ と相対速度 $\mathbf{u}$ の変換式）を提示してください。これが緩和過程の再現に不可欠です。
- 外部ファイル読み込みとデータ補間のロジックを設計してください。1次補完で十分です
- データの読み込みについては既存のコードを参考にしてください。
- 不足している情報、実装において複数の選択肢がある場合はこの段階で、質問し確認をしてください。
- 類似のシミュレーションコードが既に２つ存在しています。参考にして設計してください。

## Step 2: 実装 (Implementation)
- 設計に基づき、Fortranコードを記述してください。
- 変数宣言は必ず `implicit none` を使用してください。
- コードはcode/,実行ファイルはrun/に置くようにすること
- 定数は `double precision` (kind=8) を使用してください。

## Step 3: 検証ガイド (Verification Guide)
- **判定基準:**
    - CXのみの場合: 1回の衝突時間スケール $\tau \approx 1/\nu$ で急速に $T_{bg}$ に一致するか？
    - 弾性衝突のみの場合: 質量比 $m_{test}/m_{bg}$ に依存した緩和時間で $T_{bg}$ に漸近するか？
    - これらを確認するためのgnuplotスクリプト例を提示してください。